$(window).on("load",function(){var chartColors=["#e91e63","#9c27b0","#673ab7","#f44336","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4caf50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722","#795548","#9e9e9e","#607d8b"],skipCap=5,skipIndex=5,charts={workers:void 0,hashrate:void 0,distWorkers:void 0,distHashrate:void 0},graphData={workers:[],hashrate:[],blocks:[]},getHashrateString=function(hash){for(var hashrate=hash,i=0,units=["H/s","KH/s","MH/s","GH/s","TH/s","PH/s"];hashrate>1e3;)hashrate/=1e3,i++;return null===hashrate?"0 H/s":hashrate.toFixed(2)+" "+units[i]},emaProcess=function(dataObjArray,timePeriods=12){var k=2/(timePeriods+1);dataObjArray[0].ema=dataObjArray[0].original;let emaArray=[dataObjArray[0]];for(let i=1;i<dataObjArray.length;i++){let e=dataObjArray[i].original*k;e+=emaArray[i-1].ema*(1-k),dataObjArray[i].ema=e,emaArray.push(dataObjArray[i])}return dataObjArray},getTransparentHex=function(hex,opacity){let r,g,b;return hex=hex.replace("#",""),"rgba("+parseInt(hex.substring(0,2),16)+","+parseInt(hex.substring(2,4),16)+","+parseInt(hex.substring(4,6),16)+","+opacity/100+")"},handlePoolEntry=function(time,pool){return pool?skipIndex<5?(skipIndex++,{workers:{x:time,y:pool.workerCount},blocks:{x:time,y:pool.blocks.pending}}):(skipIndex=0,{workers:{x:time,y:pool.workerCount},hashrate:{x:time,y:pool.hashrate,original:pool.hashrate,ema:0},blocks:{x:time,y:pool.blocks.pending}}):{}},finalizeGraphDataBuild=function(data){return Object.keys(data.hashrate).forEach(function(pool){emaProcess(data.hashrate[pool].data,24)}),Object.keys(data).forEach(function(i){let item=data[i],latest=data.latest[i];if(item&&latest)for(let e in item)if(Object.prototype.hasOwnProperty.call(item,e)){let entry=item[e];if(entry){let last=entry.data[entry.data.length-1];last&&(latest.labels.push(e),latest.data.push(last.y))}}}),data},buildGraphData=function(data){var store={pools:[],workers:{},hashrate:{},blocks:{},latest:{workers:{labels:[],data:[]},hashrate:{labels:[],data:[]}}};for(let i=0;i<data.length;i++){let item=data[i];if(item){let time=1e3*item.time,pools=item.pools;pools&&handlePools(store,time,pools)}}return finalizeGraphDataBuild(store)},handlePools=function(store,time,pools){for(let p in pools)if(Object.prototype.hasOwnProperty.call(pools,p)){store.pools.includes(p)||store.pools.push(p);let pool=pools[p],parsed=handlePoolEntry(time,pool);for(let e in parsed){let isWorkers="workers"===e,root=store[e];if(root){if(!root[p]){let index=Object.keys(root).length,color=chartColors[index%chartColors.length];root[p]={label:p,pointRadius:isWorkers?0:1,steppedLine:isWorkers,borderColor:color,backgroundColor:getTransparentHex(color,20),data:[]}}root[p].data.push(parsed[e])}}}},createLineChart=function(id,datasets,beginAtZero=!0,steps=10,stepValue=5,callback=function(value){return value}){var ctx=$(`#${id}`);return new Chart(ctx,{type:"line",data:{datasets:datasets},options:{scales:{yAxes:[{gridLines:{color:"rgba(100, 100, 100, 0.1)"},ticks:{beginAtZero:beginAtZero,steps:steps,stepValue:stepValue,callback:callback}}],xAxes:[{type:"time",distribution:"series",gridLines:{display:!1},ticks:{source:"labels"}}]}}})},createPieChart=function(id,data,reverseColors=!1,options={}){let ctx=$(`#${id}`),colors=reverseColors?chartColors.slice(0).reverse():chartColors;return new Chart(ctx,{type:"pie",data:{datasets:[{label:"Colors",backgroundColor:colors,borderColor:colors,data:data.data}],labels:data.labels},options:options})},isNewPoolAdded=function(pools){if(pools)for(let p in pools)if(Object.prototype.hasOwnProperty.call(pools,p)&&!graphData.pools.includes(p))return!0;return!1},handleData=function(data){try{graphData=buildGraphData(data),charts.workers=createLineChart("worker-chart-global",Object.values(graphData.workers),!0,5,2,value=>{if(0==value)return value;{let floor=Math.floor(value);return floor<=0?"":floor}}),charts.hashrate=createLineChart("hashrate-chart-global",Object.values(graphData.hashrate),!0,10,5,value=>getHashrateString(value)),charts.distWorkers=createPieChart("dist-worker-chart-global",graphData.latest.workers),charts.distHashrate=createPieChart("dist-hash-chart-global",graphData.latest.hashrate,!0,{tooltips:{callbacks:{label:function(tooltipItem,data){var indice=tooltipItem.index;return data.labels[indice]+": "+getHashrateString(data.datasets[0].data[indice])}}}})}catch(e){throw new Error(e)}return!0};$.getJSON("/api/pool_stats",function(data){if(!handleData(data))throw new Error("Something went wrong while loading statistics!")}),statsSource.addEventListener("message",function(e){let response=JSON.parse(e.data);if(response){let newPoolAdded=isNewPoolAdded(response.pools),time=1e3*response.time;if(handlePools(graphData,time,response.pools),newPoolAdded){if(!handleData(response))throw new Error("Something went wrong while updating statistics!")}else{Object.keys(graphData.hashrate).forEach(function(pool){emaProcess(graphData.hashrate[pool].data,24)});for(let c in charts)if(Object.prototype.hasOwnProperty.call(charts,c)){let chart=charts[c];chart&&chart.update()}}}})});